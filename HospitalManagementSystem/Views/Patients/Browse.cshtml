@using HospitalManagementSystem.Repository.Models
@model IEnumerable<Patient>

@{
    ViewData["Title"] = "All Patients";
    var currentSearchString = ViewData["CurrentSearchString"] as string; // Get search string from ViewData
}

<div class="card p-4 mx-auto mt-5" style="max-width: 1000px;">

    <h2 class="text-center mb-4 display-5 fw-bold text-dark">
        <i class="bi bi-person-lines-fill me-3 text-secondary"></i> All Patient Records
    </h2>
    <p class="text-center text-muted mb-5">
        A comprehensive list of all patients currently registered in the system.
    </p>

    <div class="row mb-4 justify-content-center align-items-center g-3">
        <div class="col-12 col-md-8 col-lg-6">
            <form asp-controller="Patients" asp-action="Browse" method="get" class="d-flex w-100">
                
                <input type="text" id="searchNameInputBrowse" name="searchString" class="form-control rounded-pill me-2 shadow-sm"
                       placeholder="Search by patient name..." value="@currentSearchString" list="patientNamesDatalistBrowse" /> 
                <datalist id="patientNamesDatalistBrowse"></datalist> 
                <button type="submit" class="btn btn-outline-primary rounded-pill shadow-sm flex-shrink-0">
                    <i class="bi bi-search me-1"></i>Search
                </button>
            </form>
        </div>
        <div class="col-12 col-md-4 col-lg-4 text-center text-md-end">
            <a asp-controller="Patients" asp-action="Index" class="btn btn-outline-secondary btn-lg">
                <i class="bi bi-arrow-left-circle me-2"></i>Back to Dashboard
            </a>
        </div>
    </div>

    @if (Model != null && Model.Any())
    {
        <div class="table-responsive mt-4">
            <table class="table table-hover table-striped shadow-sm rounded-3 overflow-hidden">
                <thead class="bg-primary text-white">
                    <tr>
                        <th scope="col" class="py-3 px-3">Name</th>
                        <th scope="col" class="py-3 px-3">Date of Birth</th>
                        <th scope="col" class="py-3 px-3">Gender</th>
                        <th scope="col" class="py-3 px-3">Contact Number</th>
                        <th scope="col" class="py-3 px-3">Address</th>
                        <th scope="col" class="py-3 px-3">Registration Time</th>
                        <th scope="col" class="py-3 px-3 text-center">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var item in Model)
                    {
                        <tr>
                            <td class="py-3 px-3">
                                @Html.DisplayFor(modelItem => item.Name)
                            </td>
                            <td class="py-3 px-3">
                                @Html.DisplayFor(modelItem => item.DateOfBirth)
                            </td>
                            <td class="py-3 px-3">
                                @Html.DisplayFor(modelItem => item.Gender)
                            </td>
                            <td class="py-3 px-3">
                                @Html.DisplayFor(modelItem => item.ContactNumber)
                            </td>
                            <td class="py-3 px-3">
                                @Html.DisplayFor(modelItem => item.Address)
                            </td>
                            <td class="py-3 px-3">@item.RegistrationDate.ToLocalTime().ToString("yyyy-MM-dd HH:mm:ss")</td>
                            <td class="py-3 px-3 text-center">
                                <div class="d-flex justify-content-center align-items-center">
                                    <a asp-action="Edit" asp-route-id="@item.PatientId" class="btn btn-sm btn-outline-primary me-1"><i class="bi bi-pencil"></i> Edit</a>
                                    <a asp-action="Details" asp-route-id="@item.PatientId" class="btn btn-sm btn-outline-info me-1"><i class="bi bi-info-circle"></i> Details</a>
                                    <a asp-action="Delete" asp-route-id="@item.PatientId" class="btn btn-sm btn-outline-danger"><i class="bi bi-trash"></i> Delete</a>
                                </div>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    }
    else
    {
        <div class="alert alert-info text-center mt-4 p-4 shadow-sm" role="alert">
            <h4 class="alert-heading"><i class="bi bi-info-circle-fill me-2"></i>No Patient Records Found!</h4>
            <p class="mb-0">There are no patient records currently in the system. Start by <a asp-action="Create" class="alert-link">registering a new patient</a>.</p>
        </div>
    }
</div>

@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }

    <script type="text/javascript">
        $(document).ready(function () {
            var searchInput = $('#searchNameInput');
            var patientNamesDatalist = $('#patientNamesDatalist');
            var debounceTimer;

            searchInput.on('input', function () {
                clearTimeout(debounceTimer);
                var searchTerm = $(this).val();

                if (searchTerm.length > 1) {
                    debounceTimer = setTimeout(function () {
                        $.ajax({
                            url: '@Url.Action("GetPatientNamesSuggestions", "Patients")',
                            type: 'GET',
                            data: { term: searchTerm },
                            success: function (data) {
                                patientNamesDatalist.empty();
                                if (data && data.length > 0) {
                                    $.each(data, function (index, value) {
                                        patientNamesDatalist.append($('<option>').attr('value', value));
                                    });
                                }
                            },
                            error: function (xhr, status, error) {
                                console.error("Error fetching suggestions:", error);
                            }
                        });
                    }, 300);
                } else {
                    patientNamesDatalist.empty();
                }
            });
        });
    </script>
}